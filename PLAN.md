# План разработки сервиса

## 1. Подготовка окружения и инфраструктуры

- **Docker:**
    - Убедиться, что приложение запускается командой `docker compose up`.
- **Конфигурация:**
    - Настроить загрузку переменных окружения в приложении.

## 2. Проектирование базы данных

- **Анализ API:**
    - Изучить структуру данных, возвращаемых эндпоинтом `https://common-api.wildberries.ru/api/v1/tariffs/box`.
    - Определить оптимальную схему для хранения тарифов, учитывая ежедневное накопление и обновление.
- **Миграции Knex.js:**
    - Создать миграцию для таблицы тарифов с использованием `knex.js`.
    - Обеспечить поддержку `PostgreSQL`.
- **Типизация:**
    - Определить TypeScript типы для данных тарифов, соответствующих схеме БД и API.

## 3. Разработка логики получения и хранения данных WB

- **Получение данных API:**
    - Реализовать функцию для выполнения запросов к `https://common-api.wildberries.ru/api/v1/tariffs/box`.
    - Обработать возможные ошибки API.
- **Сохранение и обновление в БД:**
    - Разработать логику для сохранения полученных тарифов в PostgreSQL.
    - Реализовать механизм ежедневного накопления данных.
    - Настроить, чтобы ежечасные получения данных обновляли (upsert) уже имеющиеся данные за текущий день, а не создавали дубликаты.
- **Регулярное выполнение:**
    - Использовать планировщик задач (например, `node-cron` или аналогичный) для выполнения получения данных ежечасно.

## 4. Интеграция с Google Таблицами

- **Авторизация Google Sheets API:**
    - Настроить авторизацию для доступа к Google Sheets API (например, через сервисный аккаунт).
    - Убедиться, что идентификаторы таблиц и другие чувствительные данные загружаются из переменных окружения.
- **Чтение из БД:**
    - Создать функцию для выборки актуальных данных тарифов из PostgreSQL.
    - Данные должны быть отсортированы по возрастанию коэффициента.
- **Обновление Google Таблиц:**
    - Разработать логику для записи данных в произвольное количество Google Таблиц (по их ID).
    - Настроить обновление листа `stocks_coefs` в каждой таблице.
    - Обеспечить регулярное обновление данных (частоту определить, но должно быть регулярно).
    - Предусмотреть создание тестовых Google Таблиц для проверки.

## 5. Документация и Деплой

- **README.md:**
    - Написать исчерпывающую инструкцию для запуска приложения, включая:
        - Клонирование репозитория.
        - Настройка `.env` файла.
        - Запуск `docker compose up`.
        - Ожидаемый результат работы.
        - Информация о тестовых Google Таблицах.
- **Репозиторий GitHub:**
    - Разместить весь код приложения, `compose.yaml` и `README.md` на GitHub.
    - Убедиться, что чувствительные данные не хранятся напрямую в репозитории.

## 6. Тестирование

- **Unit/Integration тесты:**
    - Написать тесты для функций получения данных API.
    - Тесты для логики сохранения/обновления данных в БД.
    - Тесты для функций взаимодействия с Google Sheets API.
- **End-to-End тесты:**
    - Проверить полный цикл: получение данных -> сохранение в БД -> обновление Google Таблиц.

## Завершение

- Убедиться, что все требования из `TZ.md` выполнены.
- Проверить стабильность работы приложения в контейнерах.
